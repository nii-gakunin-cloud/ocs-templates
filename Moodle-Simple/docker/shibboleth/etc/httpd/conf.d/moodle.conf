# Moodle 5.1 Router Configuration
# Explicitly set DocumentRoot to the symlinked public directory
DocumentRoot /var/www/html

# Configure the Directory block for proper routing
<Directory /var/www/html>
    # Basic permissions
    AllowOverride None
    Require all granted
    Options FollowSymLinks

    # Enable slasharguments (e.g. /file.php/123/456)
    AcceptPathInfo On

    # DirectoryIndex MUST be set for mod_dir to work correctly with FallbackResource
    DirectoryIndex index.php

    # FallbackResource routes missing files/directories to r.php
    FallbackResource /r.php

    # Security: Disable directory indexes (hide directory listings)
    Options -Indexes
</Directory>

# This sends all missing files to moodle to render nicely, see MDL-56041
ErrorDocument 404 /error/index.php

# This sends any 403 from apache through to the same page, but also
# overrides the http status with 404 instead for better security.
ErrorDocument 403 /error/index.php?code=404

# Enable rewrite engine for security rules
RewriteEngine On

# Security rules - block access to sensitive files and directories
RewriteRule "(\/vendor\/)" - [F]
RewriteRule "(\/node_modules\/)" - [F]
RewriteRule "(^|/)\.(?!well-known\/)" - [F]
RewriteRule "(composer\.json)" - [F]
RewriteRule "(\.lock)" - [F]
RewriteRule "(\/environment.xml)" - [F]
RewriteRule "(\/install.xml)" - [F]
RewriteRule "(\/README)" - [F]
RewriteRule "(\/readme)" - [F]
RewriteRule "(\/moodle_readme)" - [F]
RewriteRule "(\/upgrade\.txt)" - [F]
RewriteRule "(\/UPGRADING\.md)" - [F]
RewriteRule "(phpunit\.xml\.dist)" - [F]
RewriteRule "(\/tests\/behat\/)" - [F]
RewriteRule "(\/fixtures\/)" - [F]
